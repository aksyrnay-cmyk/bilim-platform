<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û“õ—É—à—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --bg: #f0fdf4; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0fdf4; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #111827; }
        
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-finish { background: #16a34a; margin-top: 30px; }
        
        .task-block { margin-bottom: 25px; padding: 20px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 10px; }
        
        .radio-label { display: block; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; cursor: pointer; background: white; }
        .radio-label:hover { background: #eff6ff; }
        
        .match-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .match-col { flex: 1; min-width: 200px; }
        .match-item { padding: 15px; border: 2px solid #cbd5e1; border-radius: 8px; cursor: pointer; text-align: center; margin-bottom: 10px; background: white; }
        .match-item.selected { border-color: var(--primary); background: #eff6ff; }
        .match-item.paired { background: #e2e8f0; opacity: 0.7; pointer-events: none; }
        
        .waiting-msg { text-align: center; padding: 40px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .info-box { background: #e6f7ff; border: 1px solid #91d5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="container" id="login-view">
    <h2>üì± –û“õ—É—à—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã</h2>
    
    <div id="auto-info" class="info-box" style="display:none;"></div>
    
    <input type="text" id="st-name" placeholder="–ê—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑">
    <input type="text" id="st-id" placeholder="ID –∫–æ–¥">
    
    <button class="btn" onclick="join()">–ö—ñ—Ä—É</button>
</div>

<div class="container" id="waiting-view" style="display:none;">
    <div class="waiting-msg">
        <div class="loader"></div>
        <h3>–ú“±“ì–∞–ª—ñ–º —Ç–∞–ø—Å—ã—Ä–º–∞–Ω—ã –±–∞—Å—Ç–∞“ì–∞–Ω—à–∞ –∫“Ø—Ç—ñ“£—ñ–∑...</h3>
    </div>
</div>

<div class="container" id="exam-view" style="display:none;">
    <h2 style="color:var(--primary); text-align:center;">–°”ô—Ç—Ç—ñ–ª—ñ–∫!</h2>
    <div id="tasks-container"></div>
    <button class="btn btn-finish" onclick="finish()">–ê–Ø“ö–¢–ê–£</button>
</div>

<script>
    let myId = "";
    let room = "";
    let tasks = null;
    let selLeft = null;
    let matchedPairs = [];

    // URL-–¥–µ–Ω ID –∞–ª—É
    window.addEventListener('load', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        
        if(roomFromUrl) {
            document.getElementById('st-id').value = roomFromUrl;
            document.getElementById('auto-info').style.display = 'block';
            document.getElementById('auto-info').innerHTML = '‚úÖ ID –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –µ–Ω–≥—ñ–∑—ñ–ª–¥—ñ';
        }
    });

    function join() {
        let name = document.getElementById('st-name').value.trim();
        room = document.getElementById('st-id').value.trim();
        
        if(!name || !room) {
            alert("–ê—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑–¥—ñ –∂”ô–Ω–µ ID-–Ω—ã —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");
            return;
        }
        
        // –¢–µ–∫—Å–µ—Ä—É
        let sessionData = localStorage.getItem('edu_session_' + room);
        if(!sessionData) {
            alert("“ö–∞—Ç–µ: ID –¥“±—Ä—ã—Å –µ–º–µ—Å –Ω–µ–º–µ—Å–µ –º“±“ì–∞–ª—ñ–º —Ç–∞–ø—Å—ã—Ä–º–∞–Ω—ã –±–∞—Å—Ç–∞–º–∞“ì–∞–Ω");
            return;
        }
        
        let session = JSON.parse(sessionData);
        
        myId = 's' + Date.now();
        if(!session.students) session.students = {};
        
        session.students[myId] = {
            name: name,
            status: 'waiting',
            scores: { test: 0, matching: 0, essay: 0 }
        };
        
        localStorage.setItem('edu_session_' + room, JSON.stringify(session));
        
        // –ö“Ø—Ç—É –±–µ—Ç—ñ–Ω–µ ”©—Ç—É
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('waiting-view').style.display = 'block';
        
        // –ú“±“ì–∞–ª—ñ–º–Ω—ñ“£ –±–∞—Å—Ç–∞—É—ã–Ω –∫“Ø—Ç—É
        let waitInterval = setInterval(function() {
            let current = JSON.parse(localStorage.getItem('edu_session_' + room));
            if(current && current.status === 'started') {
                clearInterval(waitInterval);
                
                current.students[myId].status = 'started';
                localStorage.setItem('edu_session_' + room, JSON.stringify(current));
                
                tasks = current.tasks;
                startExam();
            }
        }, 1000);
    }

    function startExam() {
        document.getElementById('waiting-view').style.display = 'none';
        document.getElementById('exam-view').style.display = 'block';
        
        let html = '';
        
        // –¢–µ—Å—Ç—Ç–µ—Ä
        if(tasks.test.length > 0) {
            html += '<h3>üìã –¢–µ—Å—Ç</h3>';
            tasks.test.forEach((t, i) => {
                html += `<div class="task-block"><b>${i+1}. ${t.q}</b>`;
                t.options.forEach(opt => {
                    html += `<label class="radio-label">
                        <input type="radio" name="q${i}" value="${opt}"> ${opt}
                    </label>`;
                });
                html += '</div>';
            });
        }
        
        // –°”ô–π–∫–µ—Å—Ç–µ–Ω–¥—ñ—Ä—É
        if(tasks.matching.length > 0) {
            html += '<h3>üîó –°”ô–π–∫–µ—Å—Ç–µ–Ω–¥—ñ—Ä—É</h3>';
            html += '<div class="task-block"><div class="match-container">';
            
            let leftItems = tasks.matching.map((m, idx) => ({ text: m.left.text, id: idx }));
            let rightItems = tasks.matching.map((m, idx) => ({ text: m.right.text, id: idx }));
            
            // –ö–µ–∑–¥–µ–π—Å–æ“õ —Ä–µ—Ç—Ç–µ—É
            leftItems.sort(() => Math.random() - 0.5);
            rightItems.sort(() => Math.random() - 0.5);
            
            html += '<div class="match-col">';
            leftItems.forEach((item, i) => {
                html += `<div class="match-item" onclick="selectLeft(this, ${item.id})">${item.text}</div>`;
            });
            html += '</div>';
            
            html += '<div class="match-col">';
            rightItems.forEach((item, i) => {
                html += `<div class="match-item" onclick="selectRight(this, ${item.id})">${item.text}</div>`;
            });
            html += '</div>';
            
            html += '</div></div>';
        }
        
        // –≠—Å—Å–µ
        if(tasks.essay.length > 0) {
            html += '<h3>‚úçÔ∏è –≠—Å—Å–µ</h3>';
            tasks.essay.forEach((text, i) => {
                let parts = text.split(/\*\*(.*?)\*\*/g);
                let newText = '';
                for(let j = 0; j < parts.length; j++) {
                    if(j % 2 === 1) {
                        newText += `<input type="text" class="essay-input" data-ans="${parts[j]}" style="width:100px; margin:0 5px; padding:5px; border-bottom:2px solid var(--primary); border-top:none; border-left:none; border-right:none; text-align:center;">`;
                    } else {
                        newText += parts[j];
                    }
                }
                html += `<div class="task-block">${newText}</div>`;
            });
        }
        
        document.getElementById('tasks-container').innerHTML = html;
    }

    function selectLeft(el, id) {
        if(el.classList.contains('paired')) return;
        document.querySelectorAll('.match-col:first-child .match-item').forEach(x => x.classList.remove('selected'));
        el.classList.add('selected');
        selLeft = { el, id };
    }

    function selectRight(el, id) {
        if(!selLeft || el.classList.contains('paired')) return;
        
        matchedPairs.push({ leftId: selLeft.id, rightId: id });
        
        selLeft.el.classList.remove('selected');
        selLeft.el.classList.add('paired');
        selLeft.el.innerText = '‚úì –¢–∞“£–¥–∞–ª–¥—ã';
        
        el.classList.add('paired');
        el.innerText = '‚úì –¢–∞“£–¥–∞–ª–¥—ã';
        
        selLeft = null;
    }

    function finish() {
        if(!confirm("–¢–∞–ø—Å—ã—Ä–º–∞–Ω—ã –∞—è“õ—Ç–∞–π—Å—ã–∑ –±–∞?")) return;
        
        let scores = { test: 0, matching: 0, essay: 0 };
        
        // –¢–µ—Å—Ç –µ—Å–µ–ø—Ç–µ—É
        tasks.test.forEach((t, i) => {
            let radios = document.getElementsByName('q' + i);
            for(let r of radios) {
                if(r.checked && r.value === t.answer) scores.test++;
            }
        });
        
        // –°”ô–π–∫–µ—Å—Ç–µ–Ω–¥—ñ—Ä—É –µ—Å–µ–ø—Ç–µ—É
        matchedPairs.forEach(p => {
            if(p.leftId === p.rightId) scores.matching++;
        });
        
        // –≠—Å—Å–µ –µ—Å–µ–ø—Ç–µ—É
        document.querySelectorAll('.essay-input').forEach(inp => {
            if(inp.value.trim().toLowerCase() === inp.dataset.ans.toLowerCase()) {
                scores.essay++;
            }
        });
        
        // –°–∞“õ—Ç–∞—É
        let session = JSON.parse(localStorage.getItem('edu_session_' + room));
        session.students[myId].scores = scores;
        session.students[myId].status = 'finished';
        localStorage.setItem('edu_session_' + room, JSON.stringify(session));
        
        document.getElementById('exam-view').innerHTML = `
            <div style="text-align:center; padding:50px;">
                <h1 style="color:#16a34a; font-size:60px;">‚úì</h1>
                <h2>–¢–∞–ø—Å—ã—Ä–º–∞ –∞—è“õ—Ç–∞–ª–¥—ã!</h2>
            </div>
        `;
    }
</script>
</body>
</html>
