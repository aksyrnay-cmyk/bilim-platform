<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú“±“ì–∞–ª—ñ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã</title>
    <style>
        :root { --primary: #2563eb; --success: #16a34a; --warning: #d97706; --danger: #dc2626; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); padding: 20px; color: #1e293b; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h2, h3 { text-align: center; color: #0f172a; }
        
        .tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; cursor: pointer; border: 2px solid var(--primary); border-radius: 8px; background: white; color: var(--primary); font-weight: 600; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; }
        
        .section { display: none; padding: 20px; border: 1px solid #e2e8f0; border-radius: 12px; background: #fbfbfc; }
        .section.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        input[type="text"], textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
        .correct-ans { border-left: 5px solid var(--success) !important; }
        
        .btn { width: 100%; padding: 14px; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 15px; }
        .btn-add { background: var(--success); }
        .btn-add:hover { background: #15803d; }
        .btn-main { background: var(--primary); font-size: 18px; }
        .btn-main:hover { background: #1d4ed8; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #e2e8f0; }
        th { background: #f1f5f9; font-weight: 600; }
        .badge { padding: 5px 10px; border-radius: 20px; color: white; font-size: 13px; font-weight: bold; display: inline-block; }
        .b-green { background: var(--success); }
        .b-yellow { background: var(--warning); }
        .b-red { background: var(--danger); }
        
        .summary-box { background: #eff6ff; border: 1px solid #bfdbfe; padding: 20px; border-radius: 12px; margin-top: 30px; display: none; }
    </style>
</head>
<body>

<div class="container" id="creator-view">
    <h2>üìö –¢–∞–ø—Å—ã—Ä–º–∞ “õ“±—Ä–∞—Å—Ç—ã—Ä—É</h2>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('test')">–¢–µ—Å—Ç</button>
        <button class="tab-btn" onclick="switchTab('matching')">–°”ô–π–∫–µ—Å—Ç–µ–Ω–¥—ñ—Ä—É</button>
        <button class="tab-btn" onclick="switchTab('essay')">–≠—Å—Å–µ</button>
    </div>

    <div id="tab-test" class="section active">
        <input type="text" id="test-q" placeholder="–°“±—Ä–∞“õ—Ç—ã –∂–∞–∑—ã“£—ã–∑...">
        <input type="text" id="opt0" class="correct-ans" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1 (–î“∞–†–´–° –ñ–ê–£–ê–ü)">
        <input type="text" id="opt1" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 2">
        <input type="text" id="opt2" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 3">
        <input type="text" id="opt3" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 4">
        <button class="btn btn-add" onclick="addTest()">‚ûï –¢–µ—Å—Ç—Ç—ñ —Å–∞“õ—Ç–∞—É</button>
    </div>

    <div id="tab-matching" class="section">
        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <div style="flex:1; min-width: 200px;">
                <input type="text" id="mlt" placeholder="–°–æ–ª –∂–∞“õ –º”ô—Ç—ñ–Ω">
                <input type="file" id="mlf" accept="image/*" style="margin-top:5px">
            </div>
            <div style="flex:1; min-width: 200px;">
                <input type="text" id="mrt" placeholder="–û“£ –∂–∞“õ –º”ô—Ç—ñ–Ω">
                <input type="file" id="mrf" accept="image/*" style="margin-top:5px">
            </div>
        </div>
        <button class="btn btn-add" onclick="addMatch()">‚ûï –ñ“±–ø—Ç—ã —Å–∞“õ—Ç–∞—É</button>
    </div>

    <div id="tab-essay" class="section">
        <p style="font-size:14px; color:#64748b; margin-top:0;">–ù“±—Å“õ–∞—É: –û“õ—É—à—ã –∂–∞–∑—É—ã —Ç–∏—ñ—Å —Å”©–∑–¥—ñ –µ–∫—ñ –∂“±–ª–¥—ã–∑—à–∞–º–µ–Ω –±–µ–ª–≥—ñ–ª–µ“£—ñ–∑. –ú—ã—Å–∞–ª—ã: –ê–±–∞–π **1845** –∂—ã–ª—ã —Ç—É“ì–∞–Ω.</p>
        <textarea id="essay-text" rows="4" placeholder="–ú”ô—Ç—ñ–Ω–¥—ñ –æ—Å—ã–Ω–¥–∞ –∂–∞–∑—ã“£—ã–∑..."></textarea>
        <button class="btn btn-add" onclick="addEssay()">‚ûï –≠—Å—Å–µ–Ω—ñ —Å–∞“õ—Ç–∞—É</button>
    </div>

    <div style="margin-top:20px; text-align:center; font-weight:bold; color:#475569;">
        “ö–æ—Å—ã–ª–¥—ã: –¢–µ—Å—Ç (<span id="c-test">0</span>) | –°”ô–π–∫–µ—Å—Ç—ñ–∫ (<span id="c-match">0</span>) | –≠—Å—Å–µ (<span id="c-essay">0</span>)
    </div>

    <button class="btn btn-main" onclick="saveAndStart()">üöÄ –¢–ê–ü–°–´–†–ú–ê–ù–´ –ë–ê–°–¢–ê–£</button>
</div>

<div class="container" id="lobby-view" style="display:none;">
    <h2>–û“õ—É—à—ã–ª–∞—Ä“ì–∞ –∞—Ä–Ω–∞–ª“ì–∞–Ω ID: <span id="room-id-display" style="color:var(--danger); font-size:40px;"></span></h2>
    <div style="text-align:center; margin-bottom: 20px;">
        <button class="btn btn-add" id="start-exam-btn" style="max-width:300px;" onclick="startExam()">üèÅ –û–†–´–ù–î–ê–£–î–´ –ë–ê–°–¢–ê–£</button>
    </div>

    <h3>üìä –û“õ—É—à—ã–ª–∞—Ä –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥—ñ</h3>
    <table id="monitor-table">
        <thead>
            <tr id="monitor-head">
                <th>–ê—Ç—ã-–∂”©–Ω—ñ</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody id="monitor-body"></tbody>
    </table>

    <div id="summary-report" class="summary-box"></div>
</div>

<script>
    let tasks = { test: [], matching: [], essay: [] };
    let sessionId = "";
    let monitorInterval;

    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('tab-' + t).classList.add('active');
    }

    function addTest() {
        let q = document.getElementById('test-q').value;
        let opts = [document.getElementById('opt0').value, document.getElementById('opt1').value, document.getElementById('opt2').value, document.getElementById('opt3').value];
        if(!q || !opts[0]) return alert("–°“±—Ä–∞“õ –ø–µ–Ω –¥“±—Ä—ã—Å –∂–∞—É–∞–ø—Ç—ã —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");
        tasks.test.push({ q, options: opts, answer: opts[0] });
        document.getElementById('c-test').innerText = tasks.test.length;
        document.querySelectorAll('#tab-test input').forEach(i => i.value = '');
    }

    async function compressImg(file) {
        if (!file) return null;
        return new Promise(resolve => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image(); img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 200 / img.width; canvas.width = 200; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                };
            };
        });
    }

    async function addMatch() {
        const lT = document.getElementById('mlt').value; const rT = document.getElementById('mrt').value;
        if(!lT && !rT) return alert("–ú”ô—Ç—ñ–Ω –∂–∞–∑—ã“£—ã–∑!");
        const lI = await compressImg(document.getElementById('mlf').files[0]);
        const rI = await compressImg(document.getElementById('mrf').files[0]);
        tasks.matching.push({ left: { text: lT, img: lI }, right: { text: rT, img: rI } });
        document.getElementById('c-match').innerText = tasks.matching.length;
        document.querySelectorAll('#tab-matching input[type="text"]').forEach(i => i.value = '');
        document.querySelectorAll('#tab-matching input[type="file"]').forEach(i => i.value = '');
    }

    function addEssay() {
        let text = document.getElementById('essay-text').value;
        if(!text) return alert("–ú”ô—Ç—ñ–Ω –∂–∞–∑—ã“£—ã–∑!");
        tasks.essay.push(text);
        document.getElementById('c-essay').innerText = tasks.essay.length;
        document.getElementById('essay-text').value = '';
    }

    function saveAndStart() {
        if(tasks.test.length === 0 && tasks.matching.length === 0 && tasks.essay.length === 0) return alert("–ê–ª–¥—ã–º–µ–Ω —Ç–∞–ø—Å—ã—Ä–º–∞ “õ–æ—Å—ã“£—ã–∑!");
        sessionId = Math.floor(1000 + Math.random() * 9000).toString();
        
        let thHtml = '<th>–ê—Ç—ã-–∂”©–Ω—ñ</th><th>–°—Ç–∞—Ç—É—Å</th>';
        if(tasks.test.length > 0) thHtml += `<th>–¢–µ—Å—Ç (Max: ${tasks.test.length})</th>`;
        if(tasks.matching.length > 0) thHtml += `<th>–°”ô–π–∫–µ—Å-—Ä—É (Max: ${tasks.matching.length})</th>`;
        if(tasks.essay.length > 0) {
            let eMax = tasks.essay.reduce((acc, text) => acc + (text.match(/\*\*(.*?)\*\*/g) || []).length, 0);
            thHtml += `<th>–≠—Å—Å–µ (Max: ${eMax})</th>`;
        }
        thHtml += '<th>–ñ–∞–ª–ø—ã % / –ë–∞“ì–∞</th>';
        document.getElementById('monitor-head').innerHTML = thHtml;

        try {
            const data = JSON.stringify({ status: 'waiting', tasks, students: {} });
            localStorage.setItem('edu_session_' + sessionId, data);
            document.getElementById('creator-view').style.display = 'none';
            document.getElementById('lobby-view').style.display = 'block';
            document.getElementById('room-id-display').innerText = sessionId;
            monitorInterval = setInterval(updateLobby, 1000);
        } catch (e) { alert("“ö–ê–¢–ï: –ñ–∞–¥—ã —Ç–æ–ª—ã–ø –∫–µ—Ç—Ç—ñ! –°—É—Ä–µ—Ç—Ç–µ—Ä–¥—ñ –∞–∑–∞–π—Ç—ã“£—ã–∑."); }
    }

    function startExam() {
        let data = JSON.parse(localStorage.getItem('edu_session_' + sessionId));
        data.status = 'started';
        localStorage.setItem('edu_session_' + sessionId, JSON.stringify(data));
        document.getElementById('start-exam-btn').style.display = 'none';
    }

    function getBadge(score, max) {
        if(max === 0) return '-';
        let pct = (score / max) * 100;
        let c = pct >= 80 ? 'b-green' : (pct >= 60 ? 'b-yellow' : 'b-red');
        return `<span class="badge ${c}">${score}/${max}</span>`;
    }

    function getTextGrade(pct) {
        if(pct >= 85) return "”®—Ç–µ –∂–∞“õ—Å—ã";
        if(pct >= 65) return "–ñ–∞“õ—Å—ã";
        if(pct >= 40) return "–û—Ä—Ç–∞";
        return "–¢”©–º–µ–Ω";
    }

    function updateLobby() {
        let data = JSON.parse(localStorage.getItem('edu_session_' + sessionId));
        if(!data) return;
        let sts = Object.values(data.students);
        let html = '';
        let allFinished = sts.length > 0;

        let eMax = tasks.essay.reduce((acc, text) => acc + (text.match(/\*\*(.*?)\*\*/g) || []).length, 0);
        let totalMax = tasks.test.length + tasks.matching.length + eMax;

        sts.forEach(s => {
            if(s.status !== 'finished') allFinished = false;
            let statusText = s.status === 'waiting' ? '‚è≥ –ö“Ø—Ç—É–¥–µ' : (s.status === 'started' ? '‚úçÔ∏è –û—Ä—ã–Ω–¥–∞—É–¥–∞' : '‚úÖ –ê—è“õ—Ç–∞–¥—ã');
            
            html += `<tr><td><b>${s.name}</b></td><td>${statusText}</td>`;
            
            if(tasks.test.length > 0) html += `<td>${s.status === 'finished' ? getBadge(s.scores.test, tasks.test.length) : '-'}</td>`;
            if(tasks.matching.length > 0) html += `<td>${s.status === 'finished' ? getBadge(s.scores.matching, tasks.matching.length) : '-'}</td>`;
            if(tasks.essay.length > 0) html += `<td>${s.status === 'finished' ? getBadge(s.scores.essay, eMax) : '-'}</td>`;
            
            if(s.status === 'finished') {
                let totalS = s.scores.test + s.scores.matching + s.scores.essay;
                let pct = (totalS / totalMax) * 100;
                let c = pct >= 80 ? 'b-green' : (pct >= 60 ? 'b-yellow' : 'b-red');
                html += `<td><span class="badge ${c}">${pct.toFixed(1)}% (${getTextGrade(pct)})</span></td>`;
            } else {
                html += `<td>-</td>`;
            }
            html += `</tr>`;
        });
        document.getElementById('monitor-body').innerHTML = html;

        if(allFinished && sts.length > 0 && !document.getElementById('summary-report').style.display.includes('block')) {
            clearInterval(monitorInterval);
            generateReport(sts, totalMax, eMax);
        }
    }

    function generateReport(sts, totalMax, eMax) {
        let tSum=0, mSum=0, eSum=0, totalSum=0;
        sts.forEach(s => {
            tSum += s.scores.test; mSum += s.scores.matching; eSum += s.scores.essay;
            totalSum += (s.scores.test + s.scores.matching + s.scores.essay);
        });

        let n = sts.length;
        let avgTotalPct = ((totalSum / n) / totalMax) * 100;
        let pT = tasks.test.length ? ((tSum/n)/tasks.test.length)*100 : null;
        let pM = tasks.matching.length ? ((mSum/n)/tasks.matching.length)*100 : null;
        let pE = eMax ? ((eSum/n)/eMax)*100 : null;

        let weak = [];
        if(pT !== null) weak.push({name: '–¢–µ—Å—Ç', val: pT});
        if(pM !== null) weak.push({name: '–°”ô–π–∫–µ—Å—Ç–µ–Ω–¥—ñ—Ä—É', val: pM});
        if(pE !== null) weak.push({name: '–≠—Å—Å–µ', val: pE});
        weak.sort((a,b) => a.val - b.val);

        let html = `<h3>üìà –ñ–∞–ª–ø—ã —Å—ã–Ω—ã–ø –µ—Å–µ–±—ñ</h3>
                    <p><b>–°—ã–Ω—ã–ø—Ç—ã“£ –æ—Ä—Ç–∞—à–∞ –∫”©—Ä—Å–µ—Ç–∫—ñ—à—ñ:</b> ${avgTotalPct.toFixed(1)}% - <b>${getTextGrade(avgTotalPct)}</b></p>
                    <ul>`;
        if(pT !== null) html += `<li>–¢–µ—Å—Ç: ${pT.toFixed(1)}%</li>`;
        if(pM !== null) html += `<li>–°”ô–π–∫–µ—Å—Ç–µ–Ω–¥—ñ—Ä—É: ${pM.toFixed(1)}%</li>`;
        if(pE !== null) html += `<li>–≠—Å—Å–µ: ${pE.toFixed(1)}%</li>`;
        html += `</ul>`;
        if(weak.length > 0) {
            html += `<p style="color:var(--danger)"><b>‚ö†Ô∏è –ï“£ —Ç”©–º–µ–Ω –∫”©—Ä—Å–µ—Ç–∫—ñ—à:</b> ${weak[0].name} (${weak[0].val.toFixed(1)}%) - –æ—Å—ã —Ç–∞“õ—ã—Ä—ã–ø—Ç—ã/—Ç–∞–ø—Å—ã—Ä–º–∞–Ω—ã “õ–∞–π—Ç–∞–ª–∞—É “õ–∞–∂–µ—Ç.</p>`;
        }
        
        let reportDiv = document.getElementById('summary-report');
        reportDiv.innerHTML = html;
        reportDiv.style.display = 'block';
    }
</script>
</body>
</html>
