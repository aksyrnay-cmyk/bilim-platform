<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>–û“õ—É—à—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã</title>
    <style>
        :root { --primary: #2563eb; --bg: #f0fdf4; --border: #e5e7eb; }
        body { font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; background: var(--bg); padding: 20px; margin: 0; color: #1f2937; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        h2, h3 { color: #111827; text-align: center; }
        
        input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        input[type="text"]:focus { border-color: var(--primary); outline: none; }
        
        .btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:hover { background: #1d4ed8; }
        .btn-finish { background: #16a34a; margin-top: 30px; }
        
        .task-block { margin-bottom: 25px; padding: 20px; background: #f8fafc; border: 1px solid #e5e7eb; border-radius: 10px; }
        
        .radio-label { display: block; padding: 10px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px; cursor: pointer; background: white; transition: 0.2s; }
        .radio-label:hover { background: #eff6ff; }
        
        .essay-text { line-height: 2; font-size: 17px; }
        .essay-input { width: 140px !important; margin: 0 5px !important; padding: 5px !important; border: none !important; border-bottom: 2px solid var(--primary) !important; border-radius: 0 !important; background: #fffbeb; text-align: center; display: inline-block; }
        
        .match-container { display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap; }
        .match-col { flex: 1; min-width: 200px; display: flex; flex-direction: column; gap: 10px; }
        .match-item { padding: 15px; border: 2px solid #cbd5e1; border-radius: 8px; cursor: pointer; text-align: center; background: white; transition: 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60px; font-weight: 500;}
        .match-item img { max-width: 100px; max-height: 80px; margin-top: 8px; border-radius: 4px;}
        .match-item.selected { border-color: var(--primary); background: #eff6ff; transform: scale(1.02); }
        .match-item.paired { background: #e2e8f0; color: #94a3b8; border-color: #cbd5e1; pointer-events: none; opacity: 0.7; }
        
        .waiting-msg { text-align: center; padding: 40px; font-size: 20px; color: #64748b; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .info-box { background: #e6f7ff; border: 1px solid #91d5ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
    </style>
</head>
<body>

<div class="container" id="login-view">
    <h2 style="text-align:center">üì± –û“õ—É—à—ã –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Å—ã–Ω–∞ –∫—ñ—Ä—É</h2>
    
    <div id="url-info" class="info-box" style="display:none;"></div>
    
    <input type="text" id="st-name" placeholder="–ê—Ç—ã-–∂”©–Ω—ñ“£—ñ–∑–¥—ñ –∂–∞–∑—ã“£—ã–∑">
    <input type="text" id="st-id" placeholder="–ú“±“ì–∞–ª—ñ–º –±–µ—Ä–≥–µ–Ω ID –∫–æ–¥">
    <button class="btn" onclick="join()">–ö—ñ—Ä—É</button>
    
    <p style="text-align:center; margin-top:20px; color:#666; font-size:14px;">
        –ú“±“ì–∞–ª—ñ–º —Å—ñ–ª—Ç–µ–º–µ –∂—ñ–±–µ—Ä—Å–µ, ID –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç–æ–ª—Ç—ã—Ä—ã–ª–∞–¥—ã
    </p>
</div>

<div class="container" id="waiting-view" style="display:none;">
    <div class="waiting-msg">
        <div class="loader"></div>
        <b>–ú“±“ì–∞–ª—ñ–º —Ç–∞–ø—Å—ã—Ä–º–∞–Ω—ã –±–∞—Å—Ç–∞“ì–∞–Ω—à–∞ –∫“Ø—Ç—ñ“£—ñ–∑...</b>
    </div>
</div>

<div class="container" id="exam-view" style="display:none;">
    <h2 style="text-align:center; color:var(--primary); border-bottom:2px solid #e5e7eb; padding-bottom:10px;">–°”ô—Ç—Ç—ñ–ª—ñ–∫!</h2>
    <div id="tasks-container"></div>
    <button class="btn btn-finish" onclick="finish()">–ê–Ø“ö–¢–ê–£ –ñ”ò–ù–ï –ñ–Ü–ë–ï–†–£</button>
</div>

<script>
    let myId = ""; 
    let room = ""; 
    let tasks = null;
    let selLeft = null; 
    let matchedPairs = []; 

    // –ë–ï–¢ –ñ“Æ–ö–¢–ï–õ–ì–ï–ù–î–ï URL-–î–ï–ù ID –ê–õ–£
    window.addEventListener('load', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const roomFromUrl = urlParams.get('room');
        
        if(roomFromUrl) {
            document.getElementById('st-id').value = roomFromUrl;
            
            const infoBox = document.getElementById('url-info');
            infoBox.style.display = 'block';
            infoBox.innerHTML = `‚úÖ ID –∫–æ–¥ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ –µ–Ω–≥—ñ–∑—ñ–ª–¥—ñ: <b>${roomFromUrl}</b><br>–¢–µ–∫ –∞—Ç—ã“£—ã–∑–¥—ã –∂–∞–∑—ã“£—ã–∑`;
        }
    });

    function join() {
        let name = document.getElementById('st-name').value.trim();
        room = document.getElementById('st-id').value.trim();
        
        if(!name || !room) return alert("–ë–∞—Ä–ª—ã“õ –∂–æ–ª–∞“õ—Ç—ã —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑!");
        
        // –¢–µ–∫—Å–µ—Ä—É: localStorage-—Ç–∞ –±–∞—Ä –º–∞?
        let session = JSON.parse(localStorage.getItem('edu_session_' + room));
        if(!session) return alert("ID “õ–∞—Ç–µ –Ω–µ–º–µ—Å–µ –º“±“ì–∞–ª—ñ–º —Ç–∞–ø—Å—ã—Ä–º–∞ –∂–∞—Å–∞–º–∞“ì–∞–Ω.");
        
        myId = Date.now().toString();
        session.students[myId] = { 
            name, 
            status: 'waiting', 
            scores: {test:0, matching:0, essay:0} 
        };
        
        localStorage.setItem('edu_session_' + room, JSON.stringify(session));
        
        document.getElementById('login-view').style.display = 'none';
        document.getElementById('waiting-view').style.display = 'block';
        
        // –ú“±“ì–∞–ª—ñ–º–Ω—ñ“£ –±–∞—Å—Ç–∞—É—ã–Ω –∫“Ø—Ç—É
        let itv = setInterval(() => {
            let s = JSON.parse(localStorage.getItem('edu_session_' + room));
            if(s && s.status === 'started') { 
                clearInterval(itv); 
                s.students[myId].status = 'started';
                localStorage.setItem('edu_session_' + room, JSON.stringify(s));
                tasks = s.tasks; 
                render(); 
            }
        }, 1000);
    }

    function shuffle(array) { 
        let newArray = [...array];
        for(let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }

    function render() {
        document.getElementById('waiting-view').style.display = 'none';
        document.getElementById('exam-view').style.display = 'block';
        let html = '';

        if(tasks.test.length > 0) {
            html += `<h3>üìã –¢–µ—Å—Ç —Ç–∞–ø—Å—ã—Ä–º–∞–ª–∞—Ä—ã</h3>`;
            tasks.test.forEach((t, i) => {
                let opts = shuffle([...t.options]);
                html += `<div class="task-block"><b>${i+1}. ${t.q}</b><div style="margin-top:10px;">`;
                opts.forEach(o => {
                    html += `<label class="radio-label"><input type="radio" name="t_${i}" value="${o}"> ${o}</label>`;
                });
                html += `</div></div>`;
            });
        }

        if(tasks.matching.length > 0) {
            html += `<h3>üîó –°”ô–π–∫–µ—Å—Ç–µ–Ω–¥—ñ—Ä—É</h3><p style="font-size:14px; color:#64748b;">–°–æ–ª –∂–∞“õ—Ç–∞“ì—ã –Ω“±—Å“õ–∞–Ω—ã –±–∞—Å—ã–ø, –æ“ì–∞–Ω —Å”ô–π–∫–µ—Å –∫–µ–ª–µ—Ç—ñ–Ω –æ“£ –∂–∞“õ—Ç–∞“ì—ã –Ω“±—Å“õ–∞–Ω—ã –±–∞—Å—ã“£—ã–∑.</p><div class="task-block"><div class="match-container">`;
            
            let lefts = tasks.matching.map((m, i) => ({...m.left, realId: i}));
            let rights = tasks.matching.map((m, i) => ({...m.right, realId: i}));
            
            // –ö–µ–∑–¥–µ–π—Å–æ“õ —Ä–µ—Ç—Ç–µ—É
            lefts = shuffle(lefts);
            rights = shuffle(rights);
            
            html += `<div class="match-col">`;
            lefts.forEach((l, i) => {
                html += `<div class="match-item l-item" id="l_${i}" data-real="${l.realId}" onclick="selectLeft(this)">
                            ${l.text || ''} ${l.img ? `<img src="${l.img}">` : ''}
                         </div>`;
            });
            html += `</div><div class="match-col">`;
            rights.forEach((r, i) => {
                html += `<div class="match-item r-item" id="r_${i}" data-real="${r.realId}" onclick="selectRight(this)">
                            ${r.text || ''} ${r.img ? `<img src="${r.img}">` : ''}
                         </div>`;
            });
            html += `</div></div></div>`;
        }

        if(tasks.essay.length > 0) {
            html += `<h3>‚úçÔ∏è –ú”ô—Ç—ñ–Ω–¥—ñ —Ç–æ–ª—ã“õ—Ç—ã—Ä—É (–≠—Å—Å–µ)</h3>`;
            tasks.essay.forEach((e, i) => {
                let text = e.replace(/\*\*(.*?)\*\*/g, `<input type="text" class="essay-input e-q-${i}" data-ans="$1">`);
                html += `<div class="task-block"><div class="essay-text">${text}</div></div>`;
            });
        }

        document.getElementById('tasks-container').innerHTML = html;
    }

    function selectLeft(el) {
        if(el.classList.contains('paired')) return;
        document.querySelectorAll('.l-item').forEach(x => x.classList.remove('selected'));
        el.classList.add('selected');
        selLeft = el;
    }

    function selectRight(el) {
        if(el.classList.contains('paired') || !selLeft) return;
        
        const leftId = parseInt(selLeft.dataset.real);
        const rightId = parseInt(el.dataset.real);
        
        matchedPairs.push({ l_id: leftId, r_id: rightId });
        
        selLeft.classList.remove('selected');
        selLeft.classList.add('paired');
        selLeft.innerHTML = "‚úì –ñ“±–ø—Ç–∞–ª–¥—ã";
        
        el.classList.add('paired');
        el.innerHTML = "‚úì –ñ“±–ø—Ç–∞–ª–¥—ã";
        
        selLeft = null;
    }

    function finish() {
        if(!confirm("–¢–∞–ø—Å—ã—Ä–º–∞–Ω—ã –∞—è“õ—Ç–∞–ø, –º“±“ì–∞–ª—ñ–º–≥–µ –∂—ñ–±–µ—Ä–µ—Å—ñ–∑ –±–µ?")) return;

        let scores = { test: 0, matching: 0, essay: 0 };
        
        // –¢–µ—Å—Ç —Ç–µ–∫—Å–µ—Ä—É
        tasks.test.forEach((t, i) => {
            let r = document.querySelector(`input[name="t_${i}"]:checked`);
            if(r && r.value === t.answer) scores.test++;
        });

        // –°”ô–π–∫–µ—Å—Ç–µ–Ω–¥—ñ—Ä—É —Ç–µ–∫—Å–µ—Ä—É
        matchedPairs.forEach(pair => {
            if(pair.l_id === pair.r_id) scores.matching++;
        });

        // –≠—Å—Å–µ —Ç–µ–∫—Å–µ—Ä—É
        tasks.essay.forEach((e, i) => {
            document.querySelectorAll(`.e-q-${i}`).forEach(inp => {
                let userAns = inp.value.trim().toLowerCase();
                let realAns = inp.dataset.ans.trim().toLowerCase();
                if(userAns === realAns) scores.essay++;
            });
        });

        // –î–µ—Ä–µ–∫—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É
        let s = JSON.parse(localStorage.getItem('edu_session_' + room));
        s.students[myId].scores = scores;
        s.students[myId].status = 'finished';
        localStorage.setItem('edu_session_' + room, JSON.stringify(s));
        
        document.getElementById('exam-view').innerHTML = `
            <div style="text-align:center; padding:50px;">
                <h1 style="color:#16a34a; font-size:60px; margin:0;">‚úì</h1>
                <h2>–¢–∞–ø—Å—ã—Ä–º–∞ –∞—è“õ—Ç–∞–ª–¥—ã!</h2>
                <p>–ñ–∞—É–∞–ø—Ç–∞—Ä—ã“£—ã–∑ –º“±“ì–∞–ª—ñ–º–≥–µ –∂—ñ–±–µ—Ä—ñ–ª–¥—ñ.</p>
            </div>
        `;
    }
</script>
</body>
</html>
